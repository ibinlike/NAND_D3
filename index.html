<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="https://d3js.org/d3.v3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
    <style>
    </style>
    <script type="text/javascript">
      function draw(geo_data) {
        "use strict";
        var margin = 75,
            width = 1400 - margin,
            height = 600 - margin;

        var svg = d3.select("body")
            .append("svg")
            .attr("width", width + margin)
            .attr("height", height + margin)
            .append('g')
            .attr('class', 'map');
        var projection = d3.geo.mercator()
                               .center([104,30])
                               .scale(700)
                               .translate( [width / 2, height / 1.2]);

        var path = d3.geo.path().projection(projection);

        var map = svg.selectAll('path')
                     .data(geo_data.features)
                     .enter()
                     .append('path')
                     .attr('d', path)
                     .style('fill', 'lightBlue')
                     .style('stroke', 'black')
                     .style('stroke-width', 0.5);


        var format = d3.time.format("%m/%d/%Y")

        d3.tsv("aqi.tsv", function(error, data){
          _.each(data, function(element, index, list){
            element.aqi = +element.aqi;
            element.date = format.parse(element.date);
          });

          function genJSON(data, groups) {

            var genGroups = function(data){
              return _.map(data, function(element, index){
                return {name: index, children : element};
            });
          }; //genGroups

            var nest = function(node, curIndex) {
              if (curIndex === 0) {
                node.children = genGroups(_.groupBy(data, groups[0]));
                _.each(node.children, function(child){
                  nest(child, curIndex +1);
                });
              }
              else {
                if (curIndex < groups.length) {
                  node.children = genGroups(
                    _.groupBy(node.children, groups[curIndex])
                  );
                  _.each(node.children, function(child){
                    nest(child, curIndex + 1);
                  });
                }
              }
              return node;
            };
            return nest({}, 0);
          } //genJSON

          var prepdata = genJSON(data, ['date'])

          var testdata = prepdata.children[0]
          //debugger;

          //_.each(testdata, function(d){
         var location = svg.selectAll(".children")
            .data(testdata.children)
            .enter()
            .append("g")
            .attr("class", "children")
            .attr("transform", function(d){
              var coor = projection([+d.lon, +d.lat]);
              return "translate("+ coor[0] + "," + coor[1] + ")";
            }); //insert element
          location.append("circle")
              .attr('fill', "#fee6ce")
              .attr("r", 7);
        }); //read tsv

}

      </script>
  </head>
<body>
  <script type="text/javascript">
  /*
    Use D3 to load the GeoJSON file
    */

d3.json("china.json", draw);

  </script>
</body>
</html>
